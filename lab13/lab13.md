# Практика 13. Канальный уровень

## Wireshark: DHCP (4 балла)
DHCP обеспечивает динамическое присваивание IP-адресов хостам.

#### Подготовка
1. Из командной строки запустите `ipconfig /release` (В Windows исполняемый файл команды
ipconfig находится в каталоге C:\windows\system32). Эта команда высвобождает ваш
актуальный IP-адрес, и IP-адрес вашего хоста становится равен 0.0.0.0.
2. Запустите анализатор пакетов Wireshark
3. Теперь вернитесь к командной строке Windows и введите ipconfig /renew. Эта команда
позволит вашему хосту получить сетевую конфигурацию, в частности, новый IP-адрес.
Дождитесь, пока команда ipconfig /renew завершит работу.
4. Чтобы просмотреть только DHCP-пакеты, введите в поле фильтра значение bootp.
(Протокол DHCP разработан на базе более старого протокола BOOTP)
При ответе на вопросы представьте соответствующие скрины.

#### Вопросы
1. Поверх какого протокола посылаются сообщения DHCP – UDP или TCP?
   - UDP
2. Каков адрес канального уровня (т.е., Ethernet-адрес) у вашего хоста?
   - `80:30:49:d0:1c:5f`
   - ![](images/12.png)
3. Каковы значения Transaction-ID в наборе (Request/ACK) DHCP-сообщений? Опишите
   назначение поля Transaction-ID.
   - `Transaction ID: 0xb658b8df`
   - Ну в названии поля хранится ответ на вопрос: `Transaction ID` позволяет отличать данный процесс получения IP-адреса от других, протекающих в то же время
   - ![](images/13.png)
4. Хост использует DHCP-протокол, в частности, для получения IP-адреса. Но IP-адрес хоста остается неподтвержденным до завершения обмена DHCP сообщениями. Если IP-адрес не установлен до завершения обмена сообщениями, то какие значения используются в  IP-дейтаграммах при обмене этими сообщениями? Укажите исходный и конечный IP-адреса, передаваемые в инкапсулирующей IP-дейтаграмме DHCP сообщений
   - При обмене сообщениями до получения IP-адреса, обычно используется адрес источника `0.0.0.0` и адрес назначения `255.255.255.255` _(широковещательный адрес)_
5. Каков IP-адрес вашего DHCP-сервера?
   - `192.168.0.1`
   - ![](images/14.png)
6. Объясните назначение срока аренды IP-адреса. Какова длительность срока аренды в вашем эксперименте?
   - Немного не понял про "назначение срока"... Ну, когда к сети подключены много устройств, а IP-адресов мало, срок аренды позволяет их повторно использовать, когда они освобождаются. А если какой-нибудь клиент, получивший адрес, выйдет из строя, то он не "заберет с собой" этот IP-адрес - у него просто рано или поздно истечет срок аренды.
   - В данном эксперименте DHCP-сервер выделяет IP адрес на 2 часа
   - ![](images/15.png)

## Программирование

### Проверка целостности пакетов (4 балла)
Реализуйте проверку целостности пакетов на основе кодов циклического контроля (Cyclic Redundancy Check, CRC).

Реализуйте тесты, показывающие корректность работы вашего решения. Для этого
предусмотрите возможность внесения ошибки (искажения) в одном или нескольких битах
данных.

Сценарий для основного теста: вводится текст, который разбивается на пакеты длинной 5 байт
(полезные данные), в некоторых из пакетов возникает ошибка (искусственная: искажение
отдельных битов). Вы должны определить, в каких пакетах возникла ошибка. Для каждого пакета
выведите на экран: полезные передаваемые данные, пакет в закодированном виде, контрольный
код.

#### Демонстрация работы
Полагаю, имелся в виду `CRC-16`. Ну, не знаю, какие несколько тестов брать, там один покрывает всю мою имплементацию:
```
Name           Stmts   Miss  Cover
----------------------------------
const.py           2      0   100%
main.py           18      0   100%
main_test.py      36      0   100%
----------------------------------
TOTAL             56      0   100%
```

Ну и сам вывод:
```
==================================================
Testing CRC-16 with packet corruption for following text:
b'Hello my name is Amir Elkanov blah blah'
==================================================

Packet 0:
        Payload:                b'Hello'
        Encoded:                48656c6c6fdada
        Expected CRC:           0xDADA
        CRC Valid?              True
--------------------------------------------------
Packet 1:
        Payload:                b' my n'
        Encoded:                216d79206eb4fb
        Expected CRC:           0xB4FB
        CRC Valid?              False
--------------------------------------------------
Packet 2:
        Payload:                b'ame i'
        Encoded:                616d6520694927
        Expected CRC:           0x4927
        CRC Valid?              True
--------------------------------------------------
Packet 3:
        Payload:                b's Ami'
        Encoded:                7320496de97f72
        Expected CRC:           0x7F72
        CRC Valid?              False
--------------------------------------------------
Packet 4:
        Payload:                b'r Elk'
        Encoded:                7220456c6b1a90
        Expected CRC:           0x1A90
        CRC Valid?              True
--------------------------------------------------
        Payload:                b'anov '
        Encoded:                616e6f762068ce
        Expected CRC:           0x68CE
        CRC Valid?              True
--------------------------------------------------
Packet 6:
        Payload:                b'blah '
        Encoded:                626c6168205009
        Expected CRC:           0x5009
        CRC Valid?              True
--------------------------------------------------
Packet 7:
        Payload:                b'blah'
        Encoded:                626c61680bc5
        Expected CRC:           0x0BC5
        CRC Valid?              True
--------------------------------------------------
```

### Подсчет сетевого трафика (8 баллов)

### Задание А (2 балла)
Разработать приложение, подсчитывающее входящий и исходящий сетевой трафик без учета
его природы.

### Задание Б (2 балла)
Разработать приложение, подсчитывающее входящий и исходящий сетевой трафик с учетом
приложения (порта), для которого данный трафик предназначен. Приложение должно
формировать отчет с разделением трафика по портам назначения/отправки.

#### Демонстрация работы

Если хочется посмотреть, то нужно установить некоторые зависимости:
```
pip install scapy netifaces prettytable
```

Раз в определенный промежуток времени _(по умолчанию - 1 сек.)_ обновляется статистика в виде таблички. В ней показываются протокол общения _(смотрю только на tcp и udp)_, порт, адрес, входящее/исходящее количество байт

Хэлпер:

```
usage: main.py [-h] [-u UPDATE_INTERVAL] [-a]

Network traffic monitor

options:
  -h, --help            show this help message and exit
  -u UPDATE_INTERVAL, --update-interval UPDATE_INTERVAL
                        Interval in seconds to update the statistics
  -a, --all-interfaces  Capture traffic on all interfaces
```

Демо табличка:

```
+----------+-------+---------------+--------------+--------------+
| Protocol |  Port |    Address    | Incoming (B) | Outgoing (B) |
+----------+-------+---------------+--------------+--------------+
|   TCP    | 44423 | 85.234.100.37 |     5647     |     2288     |
|   TCP    | 44639 | 85.234.100.37 |    12141     |     3810     |
|   TCP    | 44641 | 85.234.100.37 |     363      |     1375     |
|   TCP    | 44648 | 85.234.100.37 |     266      |     2641     |
|   TCP    | 44745 | 85.234.100.37 |      20      |      20      |
|   TCP    | 44748 | 85.234.100.37 |      40      |      40      |
|   TCP    | 44767 | 85.234.100.37 |     740      |     7117     |
|   TCP    | 44801 | 85.234.100.37 |      40      |      40      |
|   TCP    | 44803 | 85.234.100.37 |     314      |     3645     |
|   TCP    | 44812 | 85.234.100.37 |      40      |      40      |
|   TCP    | 44814 | 85.234.100.37 |      40      |      40      |
|   TCP    | 44820 | 85.234.100.37 |      40      |      40      |
|   TCP    | 44828 | 85.234.100.37 |     1500     |      72      |
|   TCP    | 44830 | 85.234.100.37 |     9112     |     4520     |
|   TCP    | 44831 | 85.234.100.37 |    45188     |    12347     |
|   TCP    | 45178 |  5.75.149.70  |     331      |     384      |
|   UDP    |  137  |  192.168.0.1  |     116      |      0       |
+----------+-------+---------------+--------------+--------------+
```

### Задание В (4 балла)
Разработать приложение, анализирующее весь сетевой трафик подсети. Приложение должно
перехватывать не только трафик, адресованный данному узлу, но и анализировать пакеты,
адресованные другим узлам сети.

При выделении записи в списке должна всплывать подсказка (hint) с более подробной
информацией: транспортный протокол (TCP/UDP), версия IP протокола, порт отправителя, порт
получателя, размер переданных данных, адреса отправителя и получателя.

Пример GUI приложения:

<img src="images/traffic.png" width=700 />

Приложение поддерживает три режима работы: отображение полного списка всех
проходящих пакетов с суммированием входящего и исходящего трафика (при нажатии на пакет в
списке выводится подробная информация); отображение суммарного входящего и исходящего
трафика по портам. 

#### Демонстрация работы
todo

### Определение всех компьютеров в сети (6 баллов)

### Задание А (4 балла)
Создайте приложение, определяющее все компьютеры (IP-адрес, MAC-адрес и имя), находящиеся
в данной сети. Компьютеры в сети находятся с использованием заданной маски (например,
255.255.255.0).

Выведите информацию о найденных компьютерах на экран. Первой строкой должны выводиться
данные о вашем компьютере в этой сети. 

### Задание Б (2 балла)
Создайте GUI для программы из Задания А, в котором есть progress bar, показывающий то,
сколько еще осталось проверить IP-адресов. Вы можете объединить решения Задания А и Б в
одном приложении.

Пример GUI приложения:

<img src="images/all-computers.png" width=500 />

#### Демонстрация работы
Если хочется посмотреть, то нужно установить некоторые зависимости:
```
pip install scapy netifaces getmac
```

Ну и сам результат:

![](images/41.png)

## Задачи

### Задача 1. (2 балла)
Вывод значения эффективности дискретного протокола ALOHA.
1. При наличии $N$ активных узлов эффективность дискретного протокола ALOHA равна 
   $N \cdot p (1 - p)^{N - 1}$. Найдите значение $p$, максимизирующее результат этого выражения.
2. Воспользовавшись значением $p$, найденным в пункте (1), найдите эффективность дискретного
протокола ALOHA, когда $N$ стремится к бесконечности.

#### Решение
1. Для фиксированного количества активных узлов $N$ мы
   максимизируем функцию $S(p) = Np(1 - p)^{N - 1}$, где $p \in \left[0, 1\right]$.

   Возьмем производную по $p$ и приравняем ее к нулю:
   $$
      \frac{dS}{dp} = N \left((1 - p)^{N - 1} - p(N - 1)(1 - p)^{N - 2}\right) = \\
      N(1 - p)^{N - 2}\left((1 - p) - p(N - 1)\right) = 0
   $$

   Т.к. для $p \in (0, 1)$ выражение $(1 - p)^{N - 2} > 0$, а $N$ - натуральное, то тогда равенство выше равносильно следующему:

   $$
      (1 - p) - p(N - 1) = 0 \Rightarrow 1 - pN = 0 \Rightarrow p^* = \frac{1}{N}
   $$

   Рассматривать крайние $p = 0, 1$ смысла нет, т.к. в них функция $S(p) \equiv 0$, когда в остальных точках $p \in (0, 1)$ она положительна

2. Подставим найденную $p^*$ в $S(p)$ и получим:
   $$
      S_{max}(N) = N \cdot \frac{1}{N} \cdot \left(1 - \frac{1}{N}\right)^{N - 1} = \left(1 - \frac{1}{N}\right)^{N - 1}
   $$

   Ну все, устремим $N \to \infty$:
   $$
      \lim_{N \to \infty} S_{max}(N) = \lim_{N \to \infty} \left[\left(1 - \frac{1}{N}\right)^{N} \cdot \left(1 - \frac{1}{N}\right)^{-1}\right] = \frac{1}{e}
   $$

### Задача 2 (3 балла)
Предположим, у нас имеются четыре активных узла – A, Б, В и Г – конкурирующих за доступ к каналу с применением дискретного протокола ALOHA. Допустим, у каждого узла есть бесконечное количество пакетов для отправки. Каждый узел пытается передать свой пакет в каждом кванте времени с вероятностью 𝑝. Первый квант имеет номер 1, второй – номер 2 и т.д.
1. Какова вероятность, что узлу A с первого раза удастся передать информацию в кванте 5?
2. Какова вероятность, что какому-либо другому узлу (Б, В или Г) с первого раза удастся передать информацию в кванте 4?
3. Какова вероятность, что первая успешная передача произойдет в кванте 3?
4. Какова эффективность этой системы, состоящей из четырех узлов?

#### Решение
Обозначим через $s = p(1 - p)^3$ вероятность того, что конкретный узел успешно передаст информацию в кадре. Тогда:
1. Первый успех A в кванте $T_A = 5$ означает 4 провала _(либо ничего не отправлял, либо коллизия имеется в виду)_ и на 5 попытке успех, т.е.:
$$
   P(T_A = 5) = (1 - s)^4s = \left(1 - p(1 - p)^3\right)^4 \cdot p(1 - p)^3
$$

1. Для любого другого узла _(Б, В, Г)_ вероятность его первого успеха в кванте 4 равна $(1 - s)^3 s$. Т.к. узла три, и их события "первый успешный квант" не пересекаются _(не более одного успешного узла в одном кванте)_, то мы просто просуммируем эти вероятности и получим:
$$
   3 \cdot (1 - s)^3s = 3 \cdot \left(1 - p(1 - p)^3\right)^3 \cdot p(1 - p)^3
$$
1. Полагаю, "первая успешная передача в кванте 3" означает, что в первых двух квантах никто из четырех не смог передать успешно, а в третьем кванте ровно один из четырех ушел без коллизий. 

   Мы уже говорили, что вероятность успеха любого конкретного узла в одном слое равна $s = p(1 - p)^3$, а узлов 4, события не пересекаются, и суммарная вероятность единственного успешного узла в кванте равна $4s = 4p(1 - p)^3$

   Ну а провалом будет соответственно $1 - 4s$. Итого получаем:
   $$
      P(\text{первый успех в 3 кванте}) = (1 - 4s)^2 \cdot (4s) = \\ \left(1 - 4p(1 - p)^3\right)^2 \cdot 4p(1 - p)^3
   $$

2. $S = Np(1 - p)^{N - 1} = 4p(1 - p)^3$, при $N = 4$


### Задача 3 (2 балла)
Рассмотрим широковещательный канал с $N$ узлами и скоростью передачи данных $R$ бит/с. Предположим, что в этом широковещательном канале используется опрос (опрос выполняется отдельным узлом) для множественного доступа. Допустим, что количество времени, за которое узел осуществляет передачу данных до соседнего узла (то есть, задержка при опросе) составляет $d_{\text{опрос}}$. Также будем исходить из того, что в каждом раунде опроса конкретному узлу разрешается передавать не более $Q$ бит. Какова будет максимальная пропускная способность широковещательного канала?

#### Решение
Максимальная пропускная способность при опросе получается, если каждый из $N$ узлов передает ровно $Q$ бит, а между передачей каждого узла тратится время опроса $d_{\text{опрос}}$.

* Время передачи $Q$ бит со скоростью $R$ бит/c равно $\frac{Q}{R}$
* Раунд опроса занимает $N(d_{\text{опрос}} + \frac{Q}{R})$
* За один раунд передается $NQ$ бит полезных данных

Итого получаем:
$$
   S = \frac{\text{Данные, переданные за 1 раунд}}{\text{Длительность раунда}} = \\ \frac{NQ}{N(d_{\text{опрос}} + \frac{Q}{R})} = \frac{Q}{d_{\text{опрос}} + \frac{Q}{R}}
$$ 